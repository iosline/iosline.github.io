<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="###一、在ViewPager上做文章（原理上可行，但实际上未起作用）viewpager默认多加载一个page
重写viewPager,将v4包里的ViewPager代码复制粘贴到新定义的LazyViewPager  
只需该一个默认变量值 
private static final int DEFAULT_OFFSCREEN_PAGES = 0;   //默认为1 改为0  即默认加载多加载0个">
<meta property="og:type" content="article">
<meta property="og:title" content="ViewPager+Fragment 懒加载">
<meta property="og:url" content="http://yoursite.com/2015/08/11/ViewPager-Fragment-懒加载/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="###一、在ViewPager上做文章（原理上可行，但实际上未起作用）viewpager默认多加载一个page
重写viewPager,将v4包里的ViewPager代码复制粘贴到新定义的LazyViewPager  
只需该一个默认变量值 
private static final int DEFAULT_OFFSCREEN_PAGES = 0;   //默认为1 改为0  即默认加载多加载0个">
<meta property="og:image" content="http://7xl32g.com1.z0.glb.clouddn.com/2015011308525158.gif">
<meta property="og:updated_time" content="2016-02-25T03:59:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ViewPager+Fragment 懒加载">
<meta name="twitter:description" content="###一、在ViewPager上做文章（原理上可行，但实际上未起作用）viewpager默认多加载一个page
重写viewPager,将v4包里的ViewPager代码复制粘贴到新定义的LazyViewPager  
只需该一个默认变量值 
private static final int DEFAULT_OFFSCREEN_PAGES = 0;   //默认为1 改为0  即默认加载多加载0个">
<meta name="twitter:image" content="http://7xl32g.com1.z0.glb.clouddn.com/2015011308525158.gif">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2015/08/11/ViewPager-Fragment-懒加载/"/>

  <title> ViewPager+Fragment 懒加载 | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                ViewPager+Fragment 懒加载
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-08-11T16:44:38+08:00" content="2015-08-11">
              2015-08-11
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>###一、在ViewPager上做文章（原理上可行，但实际上未起作用）<br>viewpager默认多加载一个page</p>
<p>重写viewPager,将v4包里的ViewPager代码复制粘贴到新定义的LazyViewPager  </p>
<p>只需该一个默认变量值 </p>
<pre><code>private static final int DEFAULT_OFFSCREEN_PAGES = 0;   //默认为1 改为0  即默认加载多加载0个
</code></pre><p>###二、在Fragment上做文章<br>做应用开发的时候，一个Activity里面可能会以viewpager（或其他容器）与多个Fragment来组合使用，而如果每个fragment都需要去加载数据，或从本地加载，或从网络加载，那么在这个activity刚创建的时候就变成需要初始化大量资源。这样的结果，我们当然不会满意。那么，能不能做到当切换到这个fragment的时候，它才去初始化呢？</p>
<p><b>答案就在Fragment里的setUserVisibleHint这个方法里</b></p>
<p>该方法用于告诉系统，这个Fragment的UI是否是可见的。所以我们只需要继承Fragment并重写该方法，即可实现在fragment可见时才进行数据加载操作，即Fragment的懒加载。</p>
<p>####效果图：<br><img src="http://7xl32g.com1.z0.glb.clouddn.com/2015011308525158.gif"></p>
<p>####代码如下：</p>
<pre><code>public abstract class BaseFragment extends Fragment {  
    protected boolean isVisible;  

    protected boolean isFirst=true;
    /** 
     * 在这里实现Fragment数据的缓加载. 
     * @param isVisibleToUser 
     */  
    @Override  
    public void setUserVisibleHint(boolean isVisibleToUser) {  
        super.setUserVisibleHint(isVisibleToUser);  
        if(getUserVisibleHint()) {  
            isVisible = true;  
            onVisible();  
        } else {  
            isVisible = false;  
            onInvisible();  
        }  
    }  

    protected void onVisible(){  
        if(isFirst){
            lazyLoad();  
            isFirst=false;
        }

    }  

    protected abstract void lazyLoad();  

    protected void onInvisible(){}  
}  
</code></pre><p>在LazyFragment，我增加了三个方法，一个是onVisiable，即fragment被设置为可见时调用，一个是onInvisible，即fragment被设置为不可见时调用。另外再写了一个lazyLoad的抽象方法，该方法在onVisible里面调用。你可能会想，为什么不在getUserVisibleHint里面就直接调用呢？</p>
<p>###使用<br>我这么写是为了代码的复用。因为在fragment中，我们还需要创建视图（onCreateView()方法），可能还需要在它不可见时就进行其他小量的初始化操作（比如初始化需要通过AIDL调用的远程服务）等。而setUserVisibleHint是在onCreateView之前调用的，那么在视图未初始化的时候，在lazyLoad当中就使用的话，就会有空指针的异常。而把lazyLoad抽离成一个方法，那么它的子类就可以这样做：</p>
<pre><code>public class CustomListFragment extends BaseFragment {

private static final String FRAGMENT_INDEX = fragment_index;
private final int FIRST_FRAGMENT = 0;
private final int SECOND_FRAGMENT = 1;
private final int THIRD_FRAGMENT = 2;

private TextView mFragmentView;

private int mCurIndex = -1;
/** 标志位，标志已经初始化完成 */
private boolean isPrepared;
/** 是否已被加载过一次，第二次就不再去请求数据了 */
private boolean mHasLoadedOnce;

/**
 * 创建新实例
 * 
 * @param index
 * @return
 */
public static CustomListFragment newInstance(int index) {
    Bundle bundle = new Bundle();
    bundle.putInt(FRAGMENT_INDEX, index);
    CustomListFragment fragment = new CustomListFragment();
    fragment.setArguments(bundle);
    return fragment;
}

@Override
public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
    if(mFragmentView == null) {
        mFragmentView = (TextView) inflater.inflate(R.layout.fragment, container, false);
        //获得索引值
        Bundle bundle = getArguments();
        if (bundle != null) {
            mCurIndex = bundle.getInt(FRAGMENT_INDEX);
        }
        isPrepared = true;
        lazyLoad();
    }

    //因为共用一个Fragment视图，所以当前这个视图已被加载到Activity中，必须先清除后再加入Activity
    ViewGroup parent = (ViewGroup)mFragmentView.getParent();
    if(parent != null) {
        parent.removeView(mFragmentView);
    }
    return mFragmentView;
}

@Override
protected void lazyLoad() {
    if (!isPrepared || !isVisible || mHasLoadedOnce) {
        return;
    }

    new AsyncTask&lt;void, boolean=&quot;&quot;&gt;() {

        @Override
        protected void onPreExecute() {
            super.onPreExecute();
            //显示加载进度对话框
            UIHelper.showDialogForLoading(getActivity(), 正在加载..., true);
        }

        @Override
        protected Boolean doInBackground(Void... params) {
            try {
                Thread.sleep(2000);
                //在这里添加调用接口获取数据的代码
                //doSomething()
            } catch (Exception e) {
                e.printStackTrace();
            }
            return true;
        }

        @Override
        protected void onPostExecute(Boolean isSuccess) {
            if (isSuccess) {
                // 加载成功
                setView();
                mHasLoadedOnce = true;
            } else {
                // 加载失败
            }
            //关闭对话框
            UIHelper.hideDialogForLoading();
        }
    }.execute();
}

private void setView() {
    // 根据索引加载不同视图
    switch (mCurIndex) {
    case FIRST_FRAGMENT:
        mFragmentView.setText(第一个);
        break;

    case SECOND_FRAGMENT:
        mFragmentView.setText(第二个);
        break;

    case THIRD_FRAGMENT:
        mFragmentView.setText(第三个);
        break;
    }
}
  }
</code></pre><p>在上面的类当中，我们增加了一个标志位isPrepared，用于标志是否初始化完成。然后在我们所需要的初始化操作完成之后调用，如上面的例子当中，在初始化view之后，设置 isPrepared为true，同时调用lazyLoad()方法。而在lazyLoad()当中，判断isPrepared和isVisible只要有一个不为true就不往下执行。也就是仅当初始化完成，并且可见的时候才继续加载，这样的避免了未初始化完成就使用而带来的问题。 </p>
<p>####注意：<br><b>这样会引发一个问题，就是fragment每次来回切换都会判断是否可见，可见就加lazyload(),就会造成加载数据，我们不想加载….</b></p>
<p>####解决办法：<br><b>在lazyFragemnt 或者在 继承lazyFragment的fragment 中添加一个 标记值 默认 mHasLoadedOnce; 加载前先判断;第一次加载之后将 mHasLoadedOnce=true;</b></p>
<p>####最后<br>到这里我们只是写好了Fragment，在FragmentActivity中还需要对ViewPager设置一下，让它每次只加载一个Fragment，ViewPager.setOffscreenPageLimit(int limit)，其中参数可以设为0或者1，参数小于1时，会默认用1来作为参数，未设置之前，ViewPager会默认加载两个Fragment。所以，我们只需要调用下它，设置下加载Fragment个数即可。</p>
<pre><code>public class MainActivity extends FragmentActivity implements OnClickListener{

    private RadioButton mFstBtn;
    private RadioButton mSndBtn;
    private RadioButton mThdBtn;

    private ViewPager mViewPager;
    private ListFragmentPagerAdapter mPagerAdapter;
    private List&lt;fragment&gt; mFragments = new ArrayList&lt;fragment&gt;();

    private final int FIRST_FRAGMENT = 0;
    private final int SECOND_FRAGMENT = 1;
    private final int THIRD_FRAGMENT = 2;


    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        initButton();
        initViewPager();
    }


    /**
     * 初始化按钮
     */
    private void initButton() {
        mFstBtn = (RadioButton)findViewById(R.id.id_rb_fst);
        mFstBtn.setOnClickListener(this);
        mSndBtn = (RadioButton)findViewById(R.id.id_rb_snd);
        mSndBtn.setOnClickListener(this);
        mThdBtn = (RadioButton)findViewById(R.id.id_rb_thd);
        mThdBtn.setOnClickListener(this);
    }


    /**
     * 初始化ViewPager控件
     */
    private void initViewPager() {
        mViewPager = (ViewPager)findViewById(R.id.id_vp_viewpager);
        //关闭预加载，默认一次只加载一个Fragment
        mViewPager.setOffscreenPageLimit(1);
        //添加Fragment
        mFragments.add(CustomListFragment.newInstance(FIRST_FRAGMENT));
        mFragments.add(CustomListFragment.newInstance(SECOND_FRAGMENT));
        mFragments.add(CustomListFragment.newInstance(THIRD_FRAGMENT));
        //适配器
        mPagerAdapter = new ListFragmentPagerAdapter(getSupportFragmentManager(), mFragments);
        mViewPager.setAdapter(mPagerAdapter);
        mViewPager.setOnPageChangeListener(onPageChangeListener);
    }


    private OnPageChangeListener onPageChangeListener = new OnPageChangeListener() {

        @Override
        public void onPageSelected(int position) {
            //根据用户选中的按钮修改按钮样式
            switch (position) {
            case FIRST_FRAGMENT:
                mFstBtn.setChecked(true);
                mSndBtn.setChecked(false);
                mThdBtn.setChecked(false);
                break;

            case SECOND_FRAGMENT:
                mFstBtn.setChecked(false);
                mSndBtn.setChecked(true);
                mThdBtn.setChecked(false);
                break;

            case THIRD_FRAGMENT:
                mFstBtn.setChecked(false);
                mSndBtn.setChecked(false);
                mThdBtn.setChecked(true);
            break;
            }
        }

        @Override
        public void onPageScrolled(int arg0, float arg1, int arg2) {}

        @Override
        public void onPageScrollStateChanged(int arg0) {}
    };


    @Override
    public void onClick(View v) {
        switch (v.getId()) {
        case R.id.id_rb_fst:
            mViewPager.setCurrentItem(FIRST_FRAGMENT);
            break;

        case R.id.id_rb_snd:
            mViewPager.setCurrentItem(SECOND_FRAGMENT);
            break;

        case R.id.id_rb_thd:
            mViewPager.setCurrentItem(THIRD_FRAGMENT);
            break;
        }
    }
}
</code></pre><p>####小需求：<br>在懒加载的基础上 有时还需要viewpager的缓存，也就是不需要每次都加载，viewpager默认只保持当前条目的前一个和后一个条目…</p>
<p>这是我们就需要设置缓存条目的数量</p>
<pre><code>mViewPager.setOffscreenPageLimit(limitNum);
</code></pre>
      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/08/10/ScrollView滑动到顶部或底部的响应/" rel="next" title="ScrollView滑动到顶部或底部的相应">
                <i class="fa fa-chevron-left"></i> ScrollView滑动到顶部或底部的相应
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/08/17/Android图像处理之Bitmap类/" rel="prev" title="Android图像处理之Bitmap类">
                Android图像处理之Bitmap类 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">33</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  

  

  

</body>
</html>
